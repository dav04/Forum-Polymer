<dom-module id="forum-edit">
	<template>
		<style>
            :host {
                padding: 10px;
            }
            .box {
                height: auto;
                background-color: #fff;
                border: 1px solid #000;
                padding: 10px;
                margin: 20px;
                float: left;
                text-align: center;
            }
            .boxArea {
                width: auto;
                min-width: 150px;
            }
            .field {
                padding: 5px;
                cursor: pointer;
            }
            .field-highlighted {
                background-color: cornflowerblue;
                border-radius: 15px;
            }
            .action {
                width: 17px;
                height: 17px;
            }
            iron-icon {
                cursor: pointer;
            }
            .addButton {
                margin-top: 20px;
                margin-left: auto;
                margin-right: auto;
                padding: 5px;
                border-top: 1px solid #000;
            }
            .boxInsert {
                width: 300px;
            }
            .title {
                font-weight: bold;
            }
            paper-button {
                
            }
		</style>

		<div>{{type}}</div>
        <div>{{typeId}}</div>
        
        <!-- Form to insert/edit topic or post -->
        <template is="dom-if" if="{{!_isForumEdit}}">
            <form is="iron-form" id="editForm" method="post" action="/form/handler">
                <template is="dom-if" if="{{_isTopic}}">
                    <div><paper-input name="title" value={{title}} label="Title"></paper-input></div>
                </template>
                <div><paper-input name="message" value={{message}} label="Message"></paper-input></div>
                <input name="typeid" type="hidden" value={{typeId}}>
                <paper-button on-click="_sendForm">CREA</paper-button>
            </form>
        </template>
        
        <!-- Form to insert/remove new area or section -->
        <template is="dom-if" if="{{_isForumEdit}}">
            <div class="box boxArea">
                <template is="dom-repeat" items={{area}} as="area" filter="{{computeFilter2()}}">
                    <div class="field">
                        <iron-icon icon="remove" class="action" on-click="_removeArea"></iron-icon>
                        <iron-icon icon="create" class="action" on-click="_editArea"></iron-icon>
                        <span on-click="_showSection">{{area.title}}</span>
                    </div>
                </template>
                <paper-button class="addButton" on-click="_addArea">
                    <iron-icon icon="add"></iron-icon>
                    Add area
                </paper-button>
            </div>
            
            <template is="dom-if" if="{{_tempIdArea}}">
            <div class="box boxArea">
                <template is="dom-repeat" items={{section}} as="section" filter="{{computeFilter(_tempIdArea)}}">
                    <div class="field">
                        <iron-icon icon="remove" class="action" on-click="_removeSection"></iron-icon>
                        <iron-icon icon="create" class="action" on-click="_editSection"></iron-icon>
                        <span on-click="_showSection">{{section.title}}</span>
                    </div>
                </template>
                <paper-button class="addButton" on-click="_addSection">
                    <iron-icon icon="add"></iron-icon>
                    Add section
                </paper-button>
            </div>
            </template>
            <template is="dom-if" if="{{_tempInsert}}">
                <div class="box boxInsert">
                    <div class="title">{{_tempDescInsert}}</div>
                    <form is="iron-form" id="editForm2" method="post" action="/form/handler">
                        <paper-input name="name" value={{_name}} label="Name"></paper-input>
                        <template is="dom-if" if="{{_checkSection}}">
                            <paper-input name="description" value={{_description}} label="Description"></paper-input>
                            
                            <paper-dropdown-menu id="listAreas" selected-item="{{selectedArea}}">
                                <paper-listbox class="dropdown-content" selected="{{_indexSelectArea}}">
                                    <template is="dom-repeat" items={{area}} as="area" filter="{{computeFilter3(_tempIdArea)}}">
                                        <paper-item name="{{area.id}}" on-click="_insertSelectedArea">{{area.title}}</paper-item>
                                    </template>
                                    <template is="dom-repeat" items={{area}} as="area" filter="{{computeFilter4(_tempIdArea)}}">
                                        <paper-item name="{{area.id}}" on-click="_insertSelectedArea">{{area.title}}</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>
                            <input type="hidden" name="idarea" value={{_idarea}}>
                            
                            <paper-input name="subsection" value={{_subsection}} label="SubSection"></paper-input>
                        </template>
                        <paper-button on-click="_insertArSe">Insert</paper-button>
                    </form>
                </div>
            </template>
        </template>
	</template>

	<script>
		Polymer({
			is: "forum-edit",

			properties: {
				// 
				type: {
					type: String,
                    observer: '_isNewTopic'
				},
                // 
				typeId: {
					type: Number
				},
                // Check to view or not title of form
                _isTopic: {
                    type: Boolean
                },
                // Check to view or not edit tool of forum
                _isForumEdit: {
                    type: Boolean
                },
                // 
				title: {
					type: String,
                    value: ''
				},
                // 
				message: {
					type: String,
                    value: ''
				},
                //
                area: {
                    type: Array
                },
                //
                section: {
                    type: Array
                },
                // 
				result: {
					type: Array,
                    observer: "_resultReady"
				}
			},
            
            ready: function() {
                this._tempIdArea = null;
                this._tempInsert = null;
            },
            
            _isNewTopic: function() {
                this._isTopic = this.type == "newTopic";
                this._isForumEdit = this.type == "editForum";
                return this._isTopic;
            },
            
            _insertSelectedArea: function() {
                this._idarea = this.selectedArea.name;
            },
            
            _areaOfSection: function(item) {
                return item.id == this._tempIdArea;
            },
            
            _showSection: function(e) {
                if(e.model.area != undefined) {
                    this._tempIdArea = e.model.area.id;
                    this._idarea = this._tempIdArea;
                }
                e.target.parentNode.parentNode.querySelectorAll('.field').forEach(function(el) {
                    this.classFollows('field-highlighted', e.target.parentNode, el);
                }.bind(this));
                
                this._tempInsert = null; // close edit form
            },
            
            computeFilter: function(idArea) {
                return function(section) {
                    return section.area == idArea;
                };
            },
            
            computeFilter2: function() {
                return function(area) {
                    return true;
                };
            },
            
            computeFilter3: function(idArea) {
                return function(area) {
                    return area.id == idArea;
                };
            },
            
            computeFilter4: function(idArea) {
                return function(area) {
                    return area.id != idArea;
                };
            },
            
            _editArea: function(e) {
                this._tempInsert = true;
                this._name = e.model.area.title;
                this._tempAddField = "editArea";
                this.typeId = e.model.area.id;
                this._checkSection = this._tempAddField == "editSection";
                this._tempDescInsert = "Edit name of area:";
            },
            
            _editSection: function(e) {
                this._tempInsert = true;
                this._name = e.model.section.title;
                this._description = e.model.section.description;
                this._sectionArea = e.model.section.area;
                this._sectionSub = e.model.section.subsection;
                this._tempAddField = "editSection";
                this.typeId = e.model.section.id;
                this._checkSection = this._tempAddField == "editSection";
                this._tempDescInsert = "Edit name and description of section:";
            },
            
            _removeArea: function(e) {
                this.typeId = e.model.area.id;
                var pos = this.area.findIndex(this._findIndex, this);
                var tempArea = this.splice('area', pos, 1);                
                this.notifySplices('area', [{index: pos, removed: [tempArea], addedCount: 0, object: this.area}]);
                var n = this.section.length;
                for(var i = 0; i < n; i++) {
                    if(this.section[i].area == this.typeId) {
                        var tempSection = this.section[i];
                        this.splice('section', i, 1);
                        this.notifySplices('section', [{index: i, removed: [tempSection], addedCount: 0, object: this.section}]);
                        i--; n--;
                    }
                }
                this._tempIdArea = null;
                this.fire('editArea', {type: "deleteArea", pos: pos, removed: tempArea, result: this.area});
            },
            
            _removeSection: function(e) {
                var pos = this.section.findIndex(this._findSection, e.model.section);
                var tempSection = this.splice('section', pos, 1); 
                this.notifySplices('section', [{index: pos, removed: [tempSection], addedCount: 0, object: this.section}]);
                this.fire('editSection', {type: "deleteSection", pos: pos, removed: tempSection, result: this.section});
            },
            
            _addArea: function() {
                this._tempDescInsert = "Insert name of area:";
                this._tempInsert = true;
                this._tempAddField = "area";
                this._checkSection = this._tempAddField == "section";
                this._name = null;
                this._description = null;
            },
            
            _addSection: function() {
                this._tempDescInsert = "Insert name and description of section:";
                this._tempInsert = true;
                this._tempAddField = "section";
                this._checkSection = this._tempAddField == "section";
                this._name = null;
                this._description = null;
                this._indexSelectArea = undefined;
                this._indexSelectArea = 0;
            },
            
            _sendForm: function() {
                this.result = this.$$('#editForm').serialize();
                this.$$('#editForm').reset();
            },
            
            _findIndex: function(element) {
                return element.id == this.typeId;
            },
            
            _findSection: function(element) {
                return element.id == this.id;
            },
            
            _insertArSe: function() {
                alert(JSON.stringify(this.$$('#editForm2').serialize()));
                var newField = this.$$('#editForm2').serialize();
                var name = newField.name;
                var description = newField.description;
                var area = newField.idarea;
                if(this._tempAddField == "area") {      // new area
                    if(this.area[this.area.length-1] != undefined)
                        var newid = this.area[this.area.length-1].id + 1;
                    else
                        var newid = 1;
                    this.area.push({id:newid, title: name});
                    this.notifySplices('area', [{index: (newid - 1), removed: [], addedCount: 1, object: this.area}]);
                    
                    this.fire('editArea', {type: "newArea", result: this.area});
                } else if(this._tempAddField == "section") {        // new section
                    var newid = this.section[this.section.length-1].id + 1;
                    this.section.push({id:newid, area: newField.idarea, title: name, description: description, subsection: null});
                    this.notifySplices('section', [{index: (newid - 1), removed: [], addedCount: 1, object: this.section}]);
                    
                    this.fire('editSection', {type: "newSection", result: this.section});
                } else if(this._tempAddField == "editArea") {
                    var pos = this.area.findIndex(this._findIndex, this);
                    this.area[pos].title = name;
                    this.notifyPath('area.' + pos + '.title');
                    this.fire('editArea', {type: "editArea", pos: pos, result: this.area});
                } else if(this._tempAddField == "editSection") {
                    var pos = this.section.findIndex(this._findIndex, this);
                    this.section[pos].title = name;
                    this.section[pos].description = description;
                    this.section[pos].area = area;
                    this.notifyPath('section.' + pos + '.title');
                    this.notifyPath('section.' + pos + '.description');
                    this.notifyPath('section.' + pos + '.area');
                    this.fire('editSection', {type: "editSection", id: pos, result: this.section});
                }
                this._name = null;
                this._description = null;
                this._tempInsert = false;
            },
            
            _resultReady: function() {
                this.fire('resultReady', {result: this.result});
            }
		});
	</script>
</dom-module>
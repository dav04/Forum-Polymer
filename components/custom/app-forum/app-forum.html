<!--
------------------
Structure
------------------
    app-forum
        forum-area

Pages:
    - 0: area and section
    - 1: section and topic
    - 2: message
    - 3: create topic or post
    - 4: forum parameters

Example:
    area = [{id:1, title: "Area 1"}, {id:2, title: "Area 2"}]

    section = [{id:1, area: 1, title: "Sezione 1", description: "Descrizione 1"}, 
               {id:2, area: 1, title: "Sezione 2", description: "Descrizione 2"}]

    topic = [{id:1, section: 1, title: "Topic 1", status: "open"}, 
            {id:2, section: 1, title: "Topic 2", status: "close"}]

area 1      
section2        id1
    section 8
    topic 1
    topic 2

------------------
Events
------------------
IN:
- 'getToken'        -> from client/server
- 'resultReady'     -> from 'forum-edit'
- 'editArea'        -> from 'forum-edit'
- 'editSection'     -> from 'forum-edit'
OUT:
- 'loginUserForum'  -> to client/server
- 'forumEdit'       -> to client/server

Type on 'forumEdit':
- reply                 message / typeid (topic)
- editPost              message / typeid (post)
- deletePost            
- editTopic             id (topic) / title / message / typeid (post)
- newTopic              id (topic) / title / message / typeid (section)
- newArea               
- editArea              
- deleteArea            
- newSection            
- editSection           
- deleteSection         

------------------
User
------------------
LOGIN: 
    user/password  ->  check in db  ->  return token  ->  save id and token in cookie

EDIT: 
    every editing send id and token

LOGOUT:
    unset cookie

------------------
Style
------------------
--forum-primary-color
--forum-primary-text-color
--forum-secondary-color
--forum-secondary-text-color
--app-forum

------------------
Dependencies
------------------

DA AGGIUNGERE DA QUA INVECE CHE NELL'INDEX

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
-->

<dom-module id="app-forum">
	<template>
		<style>
            :host {
                text-align: left;
                font-family: 'Roboto', sans-serif;
                --forum-primary-color: #82bfc8;
                --forum-secondary-color: #1d7fa9;
                --forum-primary-text-color: black;
                --forum-secondary-text-color: white;
            }
            .forumBox {
                display: inline-block;
                width: 100%;
                height: auto;
                min-height: 100%;
                background: var(--forum-primary-color);
                border-radius: 5px;
                
                @apply(--app-forum);
            }
            paper-toolbar, .newButton {
                background-color: var(--forum-secondary-color);
                color: var(--forum-secondary-text-color);
            }
            iron-pages {
                padding: 20px;
            }
            iron-icon {
                cursor: pointer;
                padding-left: 10px;
                padding-right: 10px;
            }
            .loginbar {
                text-align: center;
            }
            .logininput {
                width:100px; 
                float:left; 
                margin-left: 15px;
                --paper-input-container-color: var(--forum-secondary-text-color);
                --paper-input-container-focus-color: var(--forum-primary-color);
                --paper-input-container-input-color: var(--forum-secondary-text-color);
            }
            .loginicon {
                margin-top: 15px;
            }
            .toolbarIcon {
                --iron-icon-height: 27px;
                --iron-icon-width: 27px;
            }
            .avatar {
                --iron-icon-height: 35px;
                --iron-icon-width: 35px;
            }
            .border {
                margin: 15px;
                border-left: 5px solid var(--forum-secondary-color);
                background-color: white;
            }
            .divider {
                border-bottom: 1px solid #dbdbdb;
            }
            .topicTitle {
                color: var(--forum-primary-text-color);
                text-transform: uppercase;
                font-weight: bold;
                padding: 5px;
            }
            .action {
                background-color: var(--forum-secondary-color);
                color: var(--forum-secondary-text-color);
                margin-right: 20px;
            }
            .quote {
                color: black;
            }
            .replybutton {
                float: right;
                background-color: var(--forum-secondary-color);
                color: var(--forum-secondary-text-color);
                bottom: 15px;
                right: 15px;
                position: relative;
            }
            .editbutton {
                float: right;
                background-color: white;
                color: var(--forum-secondary-color);
                border: 1px solid var(--forum-secondary-color);
                margin-top: -45px;
                margin-right: 5px;
            }
            
            @media (max-width: 800px) {
                .userToolbar {
                    background-color: white;
                    color: var(--forum-primary-text-color);
                }
                .userMenuBox {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: auto;
                    margin-left: auto;
                    padding: 10px;
                }
                .logininputM {
                    width: 200px;
                    float: left;
                    margin-left: 15px;
                    --paper-input-container-color: var(--forum-primary-text-color);
                    --paper-input-container-focus-color: var(--forum-secondary-color);
                    --paper-input-container-input-color: var(--forum-primary-text-color);
                }
                .loginButton {
                    background-color: var(--forum-secondary-color);
                    color: var(--forum-secondary-text-color);
                    height: 25px;
                    margin-left: 15px;
                }
                .colorIcon {
                    color: var(--forum-secondary-color);
                }
            }
            @media (max-width: 700px) {
                .logininputM {
                    width: 120px;
                }
                .replybutton {
                    bottom: 20px;
                    right: 30px;
                    position: fixed;
                }
                .toolbarIcon {
                    --iron-icon-height: 20px;
                    --iron-icon-width: 20px;
                }
            }
            @media (max-width: 500px) {
                paper-toolbar {
                    --paper-toolbar-title: {
                        margin-left: 0px;
                    }
                }
                .logininputM {
                    width: 100px;
                    margin-left: 5px;
                }
                .loginIconSmall {
                    padding: 0px 0px 0px 10px;
                }
            }
		</style>

		<div>
			<paper-material class="forumBox" elevation="2">
                <paper-header-panel mode="waterfall">
                    <paper-toolbar id="forumToolbar" hidden$="{{_checkUserToolbar(userToolbar, smallScreen)}}">
                        <!-- Navigation bar -->
                        <div class="navbutton">
                            <iron-icon icon="home" class="toolbarIcon" on-click="_goHome"></iron-icon>
                            <template is="dom-if" if="{{_checkBack}}">
                                <iron-icon icon="arrow-back" class="toolbarIcon" on-click="_goBack"></iron-icon>
                            </template>
                            <template is="dom-if" if="{{_checkEdit}}">
                                <iron-icon icon="create" class="toolbarIcon" on-click="_goEditForum"></iron-icon>
                            </template>
                        </div>
                        <span class="title">{{title}}</span>
                        <!-- User bar -->
                        <div class="loginbar" hidden$="{{smallScreen}}">
                            <template is="dom-if" if="{{!_checkUser}}">
                                <form is="iron-form" id="loginForm" method="post">
                                    <paper-input name="username" label="Username" class="logininput loginicon" no-label-float></paper-input>
                                    <paper-input name="password" label="Password" class="logininput loginicon" no-label-float></paper-input>
                                    <paper-button icon="send" class="loginicon" on-click="_loginUser">LOGIN</paper-button>
                                </form>
                            </template>
                            <template is="dom-if" if="{{_checkUser}}">
                                {{_userInfo.nick}}
                                <iron-icon src="{{_userInfo.avatar}}" class="toolbarIcon"></iron-icon>
                                <paper-button icon="send" class="avatar" on-click="_logoutUser">LOGOUT</paper-button>
                            </template>
                        </div>
                        <div class="loginbar" hidden$="{{!smallScreen}}">
                            <iron-icon icon="account-circle" class="avatar" hidden$="{{_checkUser}}" 
                                       on-click="_userMenu" id="avatarmenu"></iron-icon>
                            <iron-icon src="{{_userInfo.avatar}}" class="avatar" hidden$="{{!_checkUser}}" 
                                       on-click="_userMenu" id="avatarmenu"></iron-icon>
                        </div>
                    </paper-toolbar>

                    <!-- User Toolbar for screen < 800px -->
                    <paper-toolbar class="userToolbar" hidden$="{{!_checkUserToolbar(userToolbar, smallScreen)}}">
                        <div>
                            <iron-icon icon="arrow-back" class="colorIcon toolbarIcon" on-click="_userMenuClose"></iron-icon>
                        </div>
                        <div class="userMenuBox">
                            <template is="dom-if" if="{{!_checkUser}}">
                                <form is="iron-form" id="loginForm" method="post">
                                    <paper-input name="username" label="Username" class="logininputM" no-label-float></paper-input>
                                    <paper-input name="password" label="Password" class="logininputM" no-label-float></paper-input>
                                    <paper-button icon="send" class="loginButton loginicon" on-click="_loginUser" hidden$="{{mobileScreen}}">
                                        LOGIN
                                    </paper-button>
                                    <iron-icon icon="send" class="loginicon colorIcon loginIconSmall" on-click="_loginUser" hidden$="{{!mobileScreen}}"></iron-icon>
                                </form>
                            </template>
                            <template is="dom-if" if="{{_checkUser}}">
                                {{_userInfo.nick}}
                                <iron-icon src="{{_userInfo.avatar}}" class="avatar"></iron-icon>
                                <paper-button icon="send" class="loginButton" on-click="_logoutUser">LOGOUT</paper-button>
                            </template>
                        </div>
                    </paper-toolbar>

                    <div>
                        <iron-pages id="forumpages" selected="0">
                            <!-- Page with areas and sections -->
                            <div>
                                <template id="forumarea" is="dom-repeat" items={{area}} as="area" filter="{{_checkPrivilege(_userInfo)}}">
                                    <forum-area name={{area.title}}>
                                        <template id="forumsection" is="dom-repeat" items={{section}} as="section">
                                            <template is="dom-if" if="{{_checkSubSection(section.subsection)}}">
                                                <template is="dom-if" if="{{_areaFilter(area.id, section.area)}}">
                                                    <div class="divider">
                                                        <forum-section name={{section.title}} 
                                                                       description={{section.description}}
                                                                       on-click="_sectionSelect">
                                                        </forum-section>
                                                    </div>
                                                </template>
                                            </template>
                                        </template>
                                    </forum-area>
                                </template>
                            </div>
                            <!-- Page with sections and topics-->
                            <div>
                                <template is="dom-if" if="{{_checkUser}}">
                                    <paper-button class="newButton" on-click="_newTopic">New topic</paper-button>
                                </template>
                                <div class="border">
                                    <template is="dom-repeat" items={{section}} as="section" filter="{{_sectionFilter(pageFieldId)}}">
                                        <div class="divider">
                                            <forum-section name={{section.title}} 
                                                           description={{section.description}}
                                                           on-click="_sectionSelect">
                                            </forum-section>
                                        </div>
                                    </template>
                                </div>
                                <div class="border">
                                    <template id="topicList" is="dom-repeat" items={{topic}} as="topic" filter="{{_topicFilter(pageFieldId)}}">
                                        <div class="divider">
                                            <forum-topic title={{topic.title}} date="{{topic.date}}" status="{{topic.status}}" 
                                                         on-click="_topicSelect"></forum-topic>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <!-- Page with posts -->
                            <div>
                                <div class="topicTitle">{{topicName}}</div>

                                <template id="postList" is="dom-repeat" items={{post}} as="post" filter="{{_postFilter(trackPage.topic)}}">
                                    <forum-post message="{{post.message}}" date="{{post.date}}" id="{{post.id}}" 
                                                hidden$="{{_checkEditUser(post.user, post.topic)}}">
                                        <forum-user info-user={{_findUser(post.user)}} class="user"></forum-user>
                                        <forum-user info-user={{_findUser(post.user)}} class="userSmall" smart></forum-user>
                                    </forum-post>

                                    <forum-post message="{{post.message}}" date="{{post.date}}" id="{{post.id}}" usermenu 
                                                hidden$="{{!_checkEditUser(post.user, post.topic)}}">
                                        <forum-user info-user={{_findUser(post.user)}} class="user"></forum-user>
                                        <forum-user info-user={{_findUser(post.user)}} class="userSmall" smart></forum-user>
                                        <paper-fab icon="create" title="Edit post" on-click="_editPost" class="action"></paper-fab>
                                        <paper-fab icon="delete" title="Delete post" on-click="_deletePost" class="action"></paper-fab>
                                        <iron-icon icon="editor:format-quote" title="Quote" on-click="_quotePost" class="quote"></iron-icon>
                                    </forum-post>
                                </template>
                                <template is="dom-if" if="{{_checkAction}}">
                                    <paper-fab icon="reply" title="Reply" on-click="_replyPost" class="replybutton"></paper-fab>
                                </template>
                            </div>
                            <!-- Page to create topic or write post -->
                            <div>
                                <forum-edit type={{pageField}} 
                                            type-id={{pageFieldId}} 
                                            title={{_tempTitle}} 
                                            message={{_tempMessage}}
                                            area={{_tempArea}}
                                            section={{_tempSection}}
                                            topic={{_tempTopic}}>
                                </forum-edit>
                            </div>
                        </iron-pages>

                        <content></content>
                    </div>
                </paper-header-panel>
			</paper-material>
            
            <iron-media-query query="(max-width: 800px)" query-matches="{{smallScreen}}"></iron-media-query>
            <iron-media-query query="(max-width: 500px)" query-matches="{{mobileScreen}}"></iron-media-query>
		</div>
	</template>

	<script>
		Polymer({
			is: "app-forum",

			properties: {
				// title on top of forum
				title: {
					type: String,
					value: "App forum"
				},
                // array with all areas of forum
                area: {
                    type: Array,
                    value: [{id:1, title: "Area 1", priv: 0}, {id:2, title: "Area 2", priv: 0}, {id:3, title: "Area 3", priv: 1}]
                },
                // array with all sections of forum
                section: {
                    type: Array,
                    value: [{id:1, area: 1, title: "Sezione 1", description: "Descrizione 1", subsection: null}, 
                            {id:2, area: 1, title: "Sezione 2", description: "Descrizione 2", subsection: null},
                            {id:3, area: 2, title: "Sezione 3", description: "Descrizione 3", subsection: null}, 
                            {id:4, area: 2, title: "Sezione 4", description: "Descrizione 4", subsection: null}, 
                            {id:5, area: 2, title: "Sezione 5", description: "Descrizione 5", subsection: 3}, 
                            {id:6, area: 2, title: "Sezione 6", description: "Descrizione 6", subsection: 5}]
                },
                // array with all topics of forum
                topic: {
                    type: Array,
                    value: [{id:1, section: 3, title: "Topic 1", status: "open", date: "2017-01-01 00:15:27"}, 
                            {id:2, section: 1, title: "Topic 2", status: "close", date: "2017-01-11 16:01:00"},
                            {id:3, section: 4, title: "Topic 3", status: "close", date: "2017-01-12 00:00:00"}, 
                            {id:4, section: 1, title: "Topic 4", status: "open", date: "2017-01-15 00:00:00"},
                            {id:5, section: 1, title: "Topic 5", status: "open", date: "2017-01-17 00:00:00"}, 
                            {id:6, section: 4, title: "Topic 6", status: "open", date: "2017-01-21 00:00:00"},
                            {id:7, section: 3, title: "Topic 7", status: "open", date: "2017-01-22 00:00:00"}, 
                            {id:8, section: 2, title: "Topic 8", status: "close", date: "2017-02-03 00:00:00"},
                            {id:9, section: 5, title: "Topic 9", status: "open", date: "2017-02-04 00:00:00"}, 
                            {id:10, section: 2, title: "Topic 10", status: "close", date: "2017-02-05 00:00:00"}]
                },
                // array with all posts of forum
                post: {
                    type: Array,
                    value: [{id:1, topic: 3, message: "<p>Messaggio Topic 3</p>", user: 1, date: "2017-01-12 00:00:00"}, 
                            {id:2, topic: 1, message: "<p>Messaggio Topic 1</p>", user: 3, date: "2017-01-01 00:15:27"},
                            {id:3, topic: 4, message: "<p>Messaggio Topic 4</p>", user: 4, date: "2017-01-01 00:00:00"}, 
                            {id:4, topic: 1, message: "<p>Messaggio Topic 1</p>", user: 2, date: "2017-01-02 09:15:27"},
                            {id:5, topic: 9, message: "<p>Messaggio Topic 9</p>", user: 1, date: "2017-01-01 00:00:00"}, 
                            {id:6, topic: 4, message: "<p>Messaggio Topic 4</p>", user: 1, date: "2017-01-01 00:00:00"},
                            {id:7, topic: 3, message: "<p>Messaggio Topic 3</p>", user: 2, date: "2017-01-15 00:00:00"}, 
                            {id:8, topic: 2, message: "<p>Messaggio Topic 2</p>", user: 3, date: "2017-01-11 16:01:00"},
                            {id:9, topic: 1, message: "<p>Messaggio Topic 1</p>", user: 4, date: "2017-01-02 10:45:54"}, 
                            {id:10, topic: 2, message: "<p>Messaggio Topic 2</p>", user: 4, date: "2017-01-13 22:11:07"}]
                },
                // array with all users of forum
                // account: 1/admin, 2/mod, 3/user
                user: {
                    type: Array,
                    value: [{id:1, nickname: "admin", account: 1, avatar: "images/users/avatar1.jpg"}, 
                            {id:2, nickname: "dav04", account: 2, avatar: "images/users/avatar2.jpg"},
                            {id:3, nickname: "poul", account: 3, avatar: "images/users/avatar3.jpg"}, 
                            {id:4, nickname: "supervegetto86", account: 3, avatar: "images/users/avatar4.jpg"}]
                },
                // check if user is logged
                _checkUser: {
                    type: String,
                    value: false,
                    observer: "_checkStatus"
                },
                // check if action button about active user post have to be visible
                _checkActionUser: {
                    type: Boolean
                },
                // check if edit of forum button have to be visible
                _checkEdit: {
                    type: Boolean
                },
                // information about active user
                _userInfo: {
                    type: Array,
                    value: [{id: null, nick: null, account: null, avatar: null}]
                },
                // data when an edit event happens inside forum
                editEvent: {
                    type: Array,
                    reflectToAttribute: true
                },
                // name of active page
                pageField: {
                    type: String
                },
                // id of active section or topic
                pageFieldId: {
                    type: Number
                },
                // title of active topic
                topicName: {
                    type: String
                },
                // trace path of browsing
                trackPage: {
                    type: Array,
                    value: [{section: [], topic: null}]
                },
                // check to view or not back button
                _checkBack: {
                    type: Boolean
                }
			},
            
            listeners: {
                'getToken':     '_saveIdToken',
                'resultReady':  '_catchResult',
                'editArea' :    '_catchArea',
                'editSection' : '_catchSection',
                'editTopic' :   '_catchTopic'
            },
            
            ready: function() {
                this.userToolbar = false;
                
                if(document.cookie.indexOf('app_forum_user') != -1) {
                    this._userInfo.id = this._getCookie().id;
                    var pos = this.user.findIndex(this._findId, {id: this._userInfo.id});
                    this._userInfo.nick = this.user[pos].nickname;
                    this._userInfo.account = this.user[pos].account;
                    this._userInfo.avatar = this.user[pos].avatar;
                    this.notifyPath('_userInfo.avatar');
                    this._checkUser = true;
                    this._checkEdit = this._userInfo.account == 1;
                }
            },
            
            // USER
            // -----------------------
            
            // send username and password by 'loginUserForum' event
            _loginUser: function() {
                var info = this.$$('#loginForm').serialize();
                this._userInfo.nick = info.username;
                this.fire('loginUserForum', {username: info.username, password: info.password});
            },
            
            // save id and token into a cookie
            _saveIdToken: function(data) {
                this._checkUser = true;
                this._userInfo.id = data.detail.id;
                var pos = this.user.findIndex(this._findId, {id: this._userInfo.id});
                this._userInfo.account = this.user[pos].account;
                this._userInfo.avatar = this.user[pos].avatar;
                this.notifyPath('_userInfo.avatar');
                this._checkEdit = this._userInfo.account == 1;
                
                var d = new Date();
                d.setTime(d.getTime() + (30*24*60*60*1000)); // 30 days from now
                var expires = "expires="+ d.toUTCString();
                document.cookie = "app_forum_user=" + data.detail.id + "$$" + data.detail.token + ";" + expires + "; path=/";
                
                this.$.forumarea.render();
            },
            
            // logout user and delete relative cookie
            _logoutUser: function() {
                this._checkUser = false;
                this._userInfo = [{id: null, nick: null, account: null, avatar: null}];
                this.notifyPath('area');
                document.cookie = "app_forum_user=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/";
                
                this.$.forumarea.render();
            },
            
            // return id and token of user
            _getCookie: function() {
                var id = document.cookie.substring(15, document.cookie.indexOf('$$'));
                var token = document.cookie.substring(document.cookie.indexOf('$$')+2);
                return {id: id, token: token};
            },
            
            // observe status of '_checkUser'
            _checkStatus: function() {
                if(!this._checkUser) {
                    this._checkAction = false;
                    this._checkEdit = false;
                } else if(this.trackPage != undefined && this.trackPage.topic != null) {
                    this._checkAction = this.topic[this.topic.findIndex(this._findId, {id: this.trackPage.topic})].status == 'open';
                    this._checkEdit = this._userInfo.account == 1;
                }
            },
            
            // show user toolbar
            _userMenu: function() {
                this.userToolbar = true;
            },
            
            // hide user toolbar
            _userMenuClose: function() {
                this.userToolbar = false;
            },
            
            // check user toolbar with size of screen
            _checkUserToolbar: function(toolbar, screen) {
                return toolbar && screen;
            },
            
            // NAVIGATION BAR
            // -----------------------
            
            // go to homepage
            _goHome: function() {
                this.subSection = [];
                this.pageFieldId = undefined;
                this.previousPageFieldId = undefined;
                this.trackPage = [{section: [], topic: null}];
                this.$.forumpages.select(0);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // go to previous page
            _goBack: function() {
                if(this.trackPage.topic != null && this.pageField != "reply" && 
                   this.pageField != "editPost" && this.pageField != "editTopic") {
                    this.trackPage.topic = null;
                    this.pageFieldId = this.trackPage[0].section[this.trackPage[0].section.length-1];
                    this.$.forumpages.select(1);
                } else if(this.trackPage.topic != null) {
                    this.pageFieldId = this.trackPage.topic;
                    this.pageField = "topic";
                    this._tempTitle = null;
                    this._tempMessage = null;
                    this.$.forumpages.select(2);
                } else if(this.trackPage[0].section.length <= 1 && (this.pageField != "newTopic")) {
                    this.trackPage[0].section.pop();
                    this.$.forumpages.select(0);
                } else if(this.trackPage[0].section.length >= 1) {
                    if(this.pageField != "newTopic")
                        this.trackPage[0].section.pop();
                    else
                        this.pageField = "section";
                    this.pageFieldId = this.trackPage[0].section[this.trackPage[0].section.length-1];
                    this.$.forumpages.select(1);
                }
                
                if(this.$.forumpages.selected == 0) {
                    this.trackPage[0].section.length = [];
                    this.pageFieldId = undefined;
                    this.previousPageFieldId = undefined;
                }
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // go to edit structure of forum page
            _goEditForum: function() {
                this.pageField = "editForum";
                this._tempArea = this.area;
                this._tempSection = this.section;
                this._tempTopic = this.topic;
                this.$.forumpages.select(3);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // SUPPORT FUNCTION
            // -----------------------
            
            // check privilege to view an area
            _checkPrivilege: function(user) {
                return function(area) {
                    if(user.account == 1)
                        return true;
                    else
                        return area.priv != 1;
                }
            },
            
            // filter section to not see subsection
            _checkSubSection: function(sub) {
                return sub == null || sub == "";
            },
            
            // filter section with id of area
            _areaFilter: function(id1, id2) {  
                return id1 == id2;
            },
            
            // filter subsection with id of section
            _sectionFilter: function(idSection) {
                return function(section) {
                    return idSection == section.subsection;
                };
            },
            
            // filter topics with id of section
            _topicFilter: function(idSection) {
                return function(topic) {
                    return idSection == topic.section;
                };
            },
            
            // filter posts with id of topic
            _postFilter: function(idTopic) {
                return function(post) {
                    return idTopic == post.topic;
                };
            },
            
            // show topics of selected section
            _sectionSelect: function(e) {
                this.push('trackPage.0.section', e.model.section.id);
                this.pageFieldId = e.model.section.id;
                this.$.forumpages.select(1);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // show posts of selected topic
            _topicSelect: function(e) {
                this.trackPage.topic = e.model.topic.id;
                this.notifyPath('trackPage.topic');
                this.pageFieldId = e.model.topic.id;
                this.topicName = e.model.topic.title;
                this._checkAction = this._checkUser && (e.model.topic.status == 'open')
                this.$.forumpages.select(2);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // show windows to create a new topic
            _newTopic: function() {
                this.pageField = "newTopic";
                this.$.forumpages.select(3);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // check if user post is equal to active user or admin
            _checkEditUser: function(user, topic) {
                return (this._userInfo.id == user || this._userInfo.account == 1) && 
                    this.topic[this.topic.findIndex(this._findId, {id: topic})].status == 'open';
            },
            
            // show window to edit a post
            _editPost: function(e) {
                var model = this.$.postList.modelForElement(e.target);
                if(model.index == 0) {
                    this.pageField = "editTopic";
                    this._tempTitle = this.topicName;
                } else {
                    this.pageField = "editPost";
                    this._tempTitle = "";
                }
                this.pageFieldId = model.post.id;
                this._tempMessage = model.post.message;
                this.notifyPath('_tempMessage');
                this.$.forumpages.select(3);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // delete selected post
            _deletePost: function(e) {
                var model = this.$.postList.modelForElement(e.target);
                var pos = this.post.findIndex(this._findId, model.post);
                var tempPost = this.splice('post', pos, 1);
                this.editEvent = tempPost;
                this.fire('forumEdit', {type: "deletePost", auth: this._getCookie()});
            },
            
            //
            _quotePost: function(e) {
                this.pageField = "reply";
                this._tempMessage = "<div style=\"border-left: 5px solid #b3cad0; border-bottom: 1px solid #b3cad0;" + 
                                    "padding-left:15px; margin-top: 15px\"><b>" + 
                                    this._findUser(e.model.post.user).nickname + 
                                    " said:</b>\n " + 
                                    e.model.post.message + 
                                    "</div>\<p></p>";
                this.$.forumpages.select(3);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // show window to reply to a post
            _replyPost: function(e) {
                this.pageField = "reply";
                this._tempMessage = "";
                this.$.forumpages.select(3);
                this._checkBack = this.$.forumpages.selected != 0;
            },
            
            // return info of a specific user by id
            _findUser: function(id) {
                var pos = this.user.findIndex(this._findId, {id: id});
                return this.user[pos];
            },
            
            // support to find position of an id in an array
            _findId: function(element) {
                return element.id == this.id;
            },
            
            // format a date for DB (YYYY-MM-DD HH:MI:SS) or for a VIEW (MM/DD/YYYY HH:MI:SS)
            _formatDate: function(date, type) {
                var m = date.getMonth()+1;
                var month = m < 10 ? "0" + m : m; // to avoid '001'
                var day = date.getDate()+1 < 10 ? "0" + date.getDate() : date.getDate();
                var hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
                var minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
                var seconds = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
                
                if(type == "DB")
                    return date.getFullYear() + "-" + month + "-" + day + " " + hours + ":" + minutes;
                else if(type == "VIEW")
                    return month + "/" + day + "/" + date.getFullYear() + " " + hours + ":" + minutes;
            },
            
            // MANAGE RESULT
            // -----------------------
            
            // elaborate data received by the 'resultReady' event
            _catchResult: function(data) {
                var tempPageField = this.pageField;
                var date = new Date();

                // Edit title in 'topic' array and/or message in 'post' array
                if(this.pageField == "editPost" || this.pageField == "editTopic") {
                    if(this.pageField == "editTopic") {
                        data.detail.result.id = this.trackPage.topic;
                        this.editEvent = data.detail.result;
                        var ind = this.topic.findIndex(this._findId, {id: this.trackPage.topic});
                        this.topic[ind].title = this.editEvent.title;
                        this.topicName = this.editEvent.title;
                        this.notifyPath('topic.' + ind + '.title');
                    } else {
                        this.editEvent = data.detail.result;
                    }
                    var pos = this.post.findIndex(this._findId, {id: this.pageFieldId});
                    this.pageFieldId = this.post[pos].topic;
                    this.post[pos].message = this.editEvent.message;
                    this.post[pos].date = this._formatDate(date, "DB");
                    this.notifyPath('post.' + pos + '.message');
                    this.notifyPath('post.' + pos + '.date');
                    this.pageField = "topic";
                    this.$.forumpages.select(2);
                    this._checkBack = this.$.forumpages.selected != 0;
                    
                // Add a new record in 'post' array
                } else if(this.pageField == "reply") {
                    this.editEvent = data.detail.result;
                    var newid = this.post[this.post.length-1].id + 1;
                    this.post.push({id: newid, topic: this.editEvent.typeid, message: this.editEvent.message, 
                                    user: this._userInfo.id, date: this._formatDate(date, "DB")});
                    this.notifySplices('post', [{index: (this.post.length - 1), removed: [], addedCount: 1, object: this.post}]);
                    this.pageField = "topic";
                    this.$.forumpages.select(2);
                    this._checkBack = this.$.forumpages.selected != 0;
                    
                // Add a new record in 'topic' and 'post' arrays
                } else if(this.pageField == "newTopic") {
                    var newid = this.topic[this.topic.length-1].id + 1;
                    data.detail.result.id = newid;
                    this.editEvent = data.detail.result;
                    this.topic.push({id: newid, section: this.editEvent.typeid, title: this.editEvent.title, status: 'open',
                                    date: this._formatDate(date, "DB")});
                    this.notifySplices('topic', [{index: (newid - 1), removed: [], addedCount: 1, object: this.topic}]);
                    var newid2 = this.post[this.post.length-1].id + 1;
                    this.post.push({id: newid2, topic: newid, message: this.editEvent.message, user: this._userInfo.id,
                                   date: this._formatDate(date, "DB")});
                    this.notifySplices('post', [{index: (newid2 - 1), removed: [], addedCount: 1, object: this.post}]);
                    this.pageField = "section";
                    this.$.forumpages.select(1);
                    this._checkBack = this.$.forumpages.selected != 0;
                  
                // 
                } else {
                    this.$.forumpages.select(1);
                    this._checkBack = this.$.forumpages.selected != 0;
                }
                this.fire('forumEdit', {type: tempPageField, auth: this._getCookie()});
            },
            
            // elaborate data received by the 'editArea' event in forum-edit component
            _catchArea: function(data) {
                this.area = data.detail.result;
                if(data.detail.type == "newArea") {
                    this.notifySplices('area', [{index: (this.area.length - 1), removed: [], addedCount: 1, object: this.area}]);
                    this.editEvent = data.detail.result[this.area.length - 1];
                    this.$.forumarea.render();
                } else if(data.detail.type == "editArea") {
                    this.notifyPath('area.' + data.detail.pos + '.title');
                    this.editEvent = data.detail.result[data.detail.pos];
                    
                } else if(data.detail.type == "deleteArea") {
                    this.notifySplices('area', [{index: data.detail.pos, removed: [data.detail.removed], addedCount: 0, object: this.area}]);
                    this.editEvent = data.detail.removed;
                }
                
                this.fire('forumEdit', {type: data.detail.type, auth: this._getCookie()});
            },
            
            // elaborate data received by the 'editSection' event in forum-edit component
            _catchSection: function(data) {
                this.section = data.detail.result;
                if(data.detail.type == "newSection") {
                    this.notifySplices('section', [{index: (this.section.length - 1), removed: [], addedCount: 1, 
                                                object: this.section}]);
                    this.editEvent = data.detail.result[this.section.length - 1];
                    
                } else if(data.detail.type == "editSection") {
                    this.notifyPath('section.' + data.detail.pos + '.title');
                    this.notifyPath('section.' + data.detail.pos + '.description');
                    this.notifyPath('section.' + data.detail.pos + '.area');
                    if(data.detail.oldsub != this.section[data.detail.pos].subsection)
                        this.notifyPath('section.' + data.detail.pos + '.subsection');
                    this.editEvent = data.detail.result[data.detail.pos];
                      
                } else if(data.detail.type == "deleteSection") {
                    this.notifySplices('section', [{index: data.detail.pos, removed: [data.detail.removed], addedCount: 0, object: this.section}]);
                    this.editEvent = data.detail.removed;
                }
                
                this.fire('forumEdit', {type: data.detail.type, auth: this._getCookie()});
            },
            
            // elaborate data received by the 'editArea' event in forum-edit component
            _catchTopic: function(data) {
                this.editEvent = null;
                this.topic = data.detail.result;
                if(data.detail.type == "editTopic") {
                    this.notifyPath('topic.' + data.detail.pos + '.title');
                    this.notifyPath('topic.' + data.detail.pos + '.section');
                    this.notifyPath('topic.' + data.detail.pos + '.status');
                    this.editEvent = this.topic[data.detail.pos];
                    
                } else if(data.detail.type == "deleteTopic") {
                    this.notifySplices('topic', [{index: data.detail.pos, removed: [data.detail.removed], addedCount: 0, object: this.topic}]);
                    this.editEvent = data.detail.removed;
                }
                
                this.fire('forumEdit', {type: data.detail.type, auth: this._getCookie()});
            }
		});
	</script>
</dom-module>